}
}) %>%
discard(., is.null)
library(cavaR)
thrs
?thrs
cavaR::thrs
thrs = function(col, lowert, uppert, ...) {
if (!is.numeric(col))
stop("input has to be a numeric vector")
if(!is.null(lowert)){
sum(col < lowert)
} else{
sum(col > uppert)
}
}
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(2,3,4), mean)
tmp$Data <- apply(tmp$Data, c(2,3), thrs, uppert=24, lowert=NULL)
make_raster(tmp)
})
}
}) %>%
discard(., is.null)
plot(out[[1]][[1]])
plot(out[[2]][[3]])
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(2,3,4), mean)
tmp$Data <- apply(tmp$Data, c(2,3), thrs, uppert=20, lowert=NULL)
make_raster(tmp)
})
}
}) %>%
discard(., is.null)
plot(out[[1]][[1]])
library(reshape2)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean)
df <- melt(tmp$Data)
})
}
}) %>%
discard(., is.null)
head(out[[1]][[1]])
try <- head(out[[1]][[1]])
View(try)
try <-out[[1]][[1]]
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data)
})
}
}) %>%
discard(., is.null)
try <-out[[1]][[1]]
try <-out[[1]][[1]]
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start))
})
}
}) %>%
discard(., is.null)
try <-out[[1]][[1]]
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
select(-date)
})
}
}) %>%
discard(., is.null)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
dplyr::select(-date)
})
}
}) %>%
discard(., is.null)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2)) %>%
summarise(value=thrs(value, uppert=23, lowert=NULL))
})
}
}) %>%
discard(., is.null)
library(lubridate)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2)) %>%
summarise(value=thrs(value, uppert=23, lowert=NULL))
})
}
}) %>%
discard(., is.null)
try <-out[[1]][[1]]
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(c(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
dplyr::select(-date)
})
}
}) %>%
discard(., is.null)
try <-out[[1]][[1]]
try <-out[[1]][[1]]
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
out <- map(list(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(1,2), mean, na.rm=T)
df <- melt(tmp$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
dplyr::select(-date)
})
}
}) %>%
discard(., is.null)
try <-out[[1]][[1]]
try <-out[[1]][[1]] %>%
ungroup() %>%
group_by(year(date2)) %>%
summarise(value2=thrs(value, uppert=23, lowert=NULL))
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(tmp$Dates$start)) %>%
dplyr::select(-date)
}
}) %>%
discard(., is.null)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2)) %>%
summarise(value=thrs(value, uppert=23, lowert=NULL))
}
}) %>%
discard(., is.null)
try <- out[[2]]
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2), model) %>%
summarise(value=thrs(value, uppert=23, lowert=NULL))
}
}) %>%
discard(., is.null)
try <- out[[2]]
View(try)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2), model) %>%
summarise(value=thrs(value, uppert=24, lowert=NULL))
}
}) %>%
discard(., is.null)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2), model) %>%
summarise(value=thrs(value, uppert=24, lowert=NULL)) %>%
mutate(model=as.factor(model))
}
}) %>%
discard(., is.null)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(model=1, date=2) %>%
group_by(model) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2), model) %>%
summarise(value=thrs(value, uppert=24, lowert=NULL)) %>%
mutate(model=as.factor(model)) %>%
rename(year=1)
}
}) %>%
discard(., is.null)
out[[2]] %>%
ggplot(., aes(year, value, color=model))+
geom_point() %>%
geom_smooth()
out[[2]] %>%
ggplot(., aes(year, value, color=model))+
geom_point() =
geom_smooth()
out[[2]] %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth()
out[[2]] %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)
out[[2]] %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)+
theme_bw()
out[[2]] %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)+
theme_bw()+
ylab("N. days with half uncomfortable conditions")
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(models=1, date=2) %>%
group_by(models) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2), model) %>%
summarise(value=thrs(value, uppert=24, lowert=NULL)) %>%
mutate(model=as.factor(models)) %>%
rename(year=1)
}
}) %>%
discard(., is.null)
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
final$Data <- apply(final$Data, c(1,2), mean, na.rm=T)
df <- melt(final$Data) %>%
rename(models=1, date=2) %>%
group_by(models) %>%
mutate(date2=as.Date(final$Dates$start)) %>%
dplyr::select(-date) %>%
ungroup() %>%
group_by(year(date2), models) %>%
summarise(value=thrs(value, uppert=24, lowert=NULL)) %>%
mutate(model=as.factor(models)) %>%
rename(year=1)
}
}) %>%
discard(., is.null)
out[[2]] %>%
mutate(RCP="RCP8.5") %>%
left_join(mutate(out[[1]], RCP="RCP2.6")) %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)+
theme_bw()+
facet_wrap(~RCP)+
ylab("N. days with half uncomfortable conditions")
rcp2.6 <-   out[[1]] %>%
mutate(RCP="RCP2.6")
rcp8.5 <-  out[[2]] %>%
mutate(RCP="RCP8.5")
left_join(rcp2.6 , rcp8.5 ) %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)+
theme_bw()+
facet_wrap(~RCP)+
ylab("N. days with half uncomfortable conditions")
rcp2.6 <-   out[[1]] %>%
mutate(RCP="RCP2.6")
rcp8.5 <-  out[[2]] %>%
mutate(RCP="RCP8.5")
View(rcp2.6)
View(rcp8.5)
View(rcp2.6)
rbind(rcp2.6 , rcp8.5 ) %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)+
theme_bw()+
facet_wrap(~RCP)+
ylab("N. days with half uncomfortable conditions")
out <- map2(tasmax.data2$models_mbrs, hurs.data[[1]]$models_mbrs, function(x, y) {
if (!str_detect(x$Dates$start, "1980")) {
int1 <- gridArithmetics(x, 0.8, operator = "*")
int2 <- gridArithmetics(y, 500, operator = "/")
final <-  gridArithmetics(int1,int2, operator = "+")
map(list(2010:2039, 2040:2069, 2070:2099), function(x) {
tmp <- subsetGrid(final, years = x)
tmp$Data <- apply(tmp$Data, c(2,3, 4), mean, na.rm=T)
tmp$Data <- apply(tmp$Data, c(2,3), thrs, uppert=24, lowert=NULL)
make_raster(tmp)
})
}
}) %>%
discard(., is.null)
plot(out[[1]][[1]])
plot(out[[2]][[3]])
plot(out[[1]][[3]])
plot(out[[2]][[1]])
plot(out[[2]][[2]])
plot(out[[2]][[3]])
rbind(rcp2.6 , rcp8.5 ) %>%
ggplot(., aes(year, value, color=model))+
geom_point() +
geom_smooth(se=F)+
theme_bw()+
facet_wrap(~RCP)+
ylab("N. days with half uncomfortable conditions")
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
ggsave("../plots/THI.png")
library(cavaR)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2080,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
attributes(local.data)
attributes(local.data[[1]])
library(cavaR)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
attributes(local.data)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
library(cavaR)
attributes(local.data)
library(cavaR)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
attributes(local.data)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
library(cavaR)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
attributes(local.data)
library(cavaR)
local.data <- load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
attributes(local.data)
try <- local.data %>%
projections(bias.correction = F, season = 1:12, uppert=NULL, lowert = NULL, consecutive = F)
library(magrittr)
try <- local.data %>%
projections(bias.correction = F, season = 1:12, uppert=NULL, lowert = NULL, consecutive = F)
ciao <- list("ciao")
try <- ciao %>%
projections(bias.correction = F, season = 1:12, uppert=NULL, lowert = NULL, consecutive = F)
library(cavaR)
load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5")
plot(load_data(country = "Sudan", variable="tasmax", years.hist=1980:2000, years.proj=2050:2060,
path.to.data = "~/Databases/CORDEX-CORE/AFR-22", path.to.obs="~/Databases/W5E5") %>%
projections(bias.correction = F, season = 1:12, uppert=NULL, lowert = NULL, consecutive = F))
library(visualizeR)
library(downscaleR)
###################
# *** LOAD DATA ***
###################
xlim <- c(34,36)
ylim <- c(10,14)
obs <- loadGridData("W5E5", var = "tas",
years = 1991:1995, latLim = ylim, lonLim = xlim)
hist <- loadGridData("CORDEX-AFR-22_NCC-NorESM1-M_historical_r1i1p1_ICTP-RegCM4-7_v0",
var = "tas", years = 1991:1995, latLim = ylim, lonLim = xlim)
rcp <-  loadGridData("CORDEX-AFR-22_NCC-NorESM1-M_rcp85_r1i1p1_ICTP-RegCM4-7_v0",
var = "tas", years = 2051:2055, latLim = ylim, lonLim = xlim)
bc.rcp.monthly <- biasCorrection(obs, hist, rcp, precipitation = FALSE, method = "scaling", scaling.type ="additive",window = c(30,30))
# Monthly correction
bc.hist.monthly <- biasCorrection(obs, hist, hist, precipitation = FALSE, method = "scaling", scaling.type ="additive",window = c(30,30))
